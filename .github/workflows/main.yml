name: Send-papers-daily

on:
  schedule:
    # Run at 06:00 UTC daily (14:00 Beijing time)
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  # Zotero Config (Required)
  ZOTERO_ID: ${{ secrets.ZOTERO_ID }}
  ZOTERO_KEY: ${{ secrets.ZOTERO_KEY }}

  # arXiv Config (Optional - set ARXIV_QUERY to enable)
  ARXIV_QUERY: ${{ secrets.ARXIV_QUERY }}

  # PubMed Config (Optional - set PUBMED_QUERY to enable)
  PUBMED_QUERY: ${{ secrets.PUBMED_QUERY }}
  NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}

  # bioRxiv Config (Optional)
  BIORXIV_CATEGORIES: ${{ secrets.BIORXIV_CATEGORIES }}
  BIORXIV_KEYWORDS: ${{ secrets.BIORXIV_KEYWORDS }}

  # medRxiv Config (Optional)
  MEDRXIV_KEYWORDS: ${{ secrets.MEDRXIV_KEYWORDS }}

  # Email Config (Required)
  SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
  SMTP_PORT: ${{ secrets.SMTP_PORT }}
  SENDER: ${{ secrets.SENDER }}
  SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
  RECEIVER: ${{ secrets.RECEIVER }}

  # LLM Config
  USE_LLM_API: ${{ secrets.USE_LLM_API }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
  MODEL_NAME: ${{ secrets.MODEL_NAME }}

  # General Config
  MAX_PAPER_NUM: ${{ secrets.MAX_PAPER_NUM }}
  SEND_EMPTY: ${{ secrets.SEND_EMPTY }}
  FETCH_DAYS: ${{ secrets.FETCH_DAYS }}

  # Repository Variables
  ZOTERO_IGNORE: ${{ vars.ZOTERO_IGNORE }}
  LANGUAGE: ${{ vars.LANGUAGE }}

jobs:
  send-papers:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyzotero arxiv requests sentence-transformers \
                      tiktoken openai pathspec

      - name: Run paper recommendation
        run: python main_extended.py


  test-workflow:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyzotero arxiv requests sentence-transformers \
                      tiktoken openai pathspec

      - name: Run test
        env:
          TEST_MODE: "1"
        run: python main_extended.py --test
